{
	"version": 0.1,
	"transformation-sets": {
		"src-transform": {
			"db": {
				"src.db": "$db_jira_import",
				"dest.db": "$db_scrum_transform"
			},
			"transformations": {
				"components": {
					"type": "transpose_to_array",
					"cfg": {
						"src.collection": "components",
						"dest.collection": "project.components",
						"transformation": {
								"key": "project",
								"values": "component"
						}								
					}
				},
				"employees": {
					"type": "dataset",
					"cfg": {
						"src.collection": "employees",
						"dest.collection": "project.employees"
					}
				},				
				"sprint-timeline": {
					"type": "single_object",
					"cfg": {
						"src.collection": "sprint",
						"dest.collection": "sprint.timeline",
						"transformation": {
							"timeline": "obj['timeline'] = pd.date_range(obj['startDate'], obj['endDate']).strftime('%Y-%m-%d').tolist()"
						},
						"fields": ["timeline"]
					}
				},
				"sprint-definition": {
					"type": "single_object",
					"cfg": {
						"src.collection": "sprint",
						"dest.collection": "sprint.definition"					
					}
				},
				"sprint-all_items": {
					"type": "dataset",
					"cfg": {
						"src.collection": "backlog",
						"dest.collection": "sprint.all_items",
						"transformation": {
							"transform_values": {
								"sec2hrs": "row['estimate'] = row['estimate']/3600 if row['estimate'] else 0"
							}
						}						
					}
				}
			}
		},
		"int-transform": {
			"db": {
				"src.db": "$db_scrum_transform",
				"dest.db": "$db_scrum_transform"
			},
			"transformations": {
				"components": {
					"type": "single_object",
					"cfg": {
						"src.collection": "project.components",
						"dest.collection": "project.components",
						"fields": ["component"]
					}
				},			
				"blocked_by": {
					"type": "transpose_from_array",
					"cfg": {
						"src.collection": "sprint.all_items",
						"dest.collection": "sprint.idx_blocked_by",
						"transformation": {
							"key": "key",
							"values": "blocked_by"
						}
					}
				},
				"assignments": {
					"type": "transpose_from_array",
					"cfg": {
						"src.collection": "sprint.all_items",
						"dest.collection": "sprint.idx_assignments",
						"transformation": {
							"key": "key",
							"values": "assignments"
						}
					}
				}				
			}
		},
		"dest-transform": {
			"db": {
				"src.db": "$db_scrum_transform",
				"dest.db": "$db_scrum_api"
			},
			"transformations": {
				"components": {
					"type": "dataset",
					"cfg": {
						"src.collection": "project.components",
						"dest.collection": "project.components"
					}
				},
				"employees": {
					"type": "dataset",
					"cfg": {
						"src.collection": "project.employees",
						"dest.collection": "project.employees"
					}
				},
				"sprint.definition": {
					"type": "single_object",
					"cfg": {
						"src.collection": "sprint.definition",
						"dest.collection": "sprint.definition"						
					}
				},
				"sprint.timeline": {
					"type": "single_object",
					"cfg": {
						"src.collection": "sprint.timeline",
						"dest.collection": "sprint.timeline"						
					}
				},
				"idx_all_items": {
					"type": "dataset",
					"cfg": {
						"src.collection": "sprint.all_items",
						"dest.collection": "sprint.idx_all_items",
						"fields": ["key"]
					}				
				},
				"backlog": {
					"type": "dataset",
					"cfg": {
						"src.collection": "sprint.all_items",
						"dest.collection": "sprint.backlog",
						"transformation": {
							"where": "type == 'Story' or type == 'Bug'",
							"order": {
								"by_column": "priority",
								"sort_order": ["Highest", "High", "Medium", "Low", "Lowest"]
							}
						},
						"fields": ["key", "type", "priority"]
					}
				},
				"backlog-details": {
					"type": "dataset",
					"cfg": {
						"src.collection": "sprint.all_items",
						"dest.collection": "sprint.backlog-details",
						"transformation": {
							"where": "type == 'Story' or type == 'Bug'"
						},	
						"fields": ["key", "type", "priority", "status", "assignee_id", "duedate", "estimate", "components", "blocked_by"]
					}
				},
				"subtasks": {
					"type": "dataset",
					"cfg": {
						"src.collection": "sprint.all_items",
						"dest.collection": "sprint.subtasks",
						"transformation": {
							"where": "type == 'Sub-task'",
							"order": {
								"by_column": "priority",
								"sort_order": ["Highest", "High", "Medium", "Low", "Lowest"]
							}
						},
						"fields": ["key", "parent", "type", "priority", "status"]
					}				
				},
				"subtasks-details": {
					"type": "dataset",
					"cfg": {
						"src.collection": "sprint.all_items",
						"dest.collection": "sprint.subtasks-details",
						"transformation": {
							"where": "type == 'Sub-task'"
						},	
						"fields": ["key", "type", "priority", "status", "assignee_id", "duedate", "estimate", "components", "blocked_by"]
					}
				},
				"assignments": {
					"type": "dataset",
					"cfg": {
						"src.collection": "sprint.idx_assignments",
						"dest.collection": "sprint.assignments",
						"transformation": {
							"regex": {
								"pattern": "^(\\S+-\\d+){1}_(\\S+-\\d+){0,1}_(\\d{4}-\\d{2}-\\d{2})_(\\S+)_(\\S+)_(\\d+(\\.\\d{1,2})*)_(\\S*)$",
								"input": "assignments"
							},
							"transform_values": {
								"parent": "row['parent'] = regex[1] if regex[1] != '' else None",
								"date": "row['date'] = regex[2]",
								"group": "row['group'] = regex[3]",
								"employee": "row['employee'] = regex[4]",
								"whrs": "row['whrs'] = regex[5]",
								"comment": "row['comment'] = regex[7]"
							}
						},	
						"fields": ["key", "parent", "date", "group", "employee", "whrs", "comment"]
					}
				}				
			}
		}
	}
}
